# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –ø—Ä–æ–∫—Å–∏ (IntegrityError: UNIQUE constraint failed)

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–∫—Å–∏ (280 —à—Ç—É–∫) –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º —Å–æ–∑–¥–∞–Ω–∏–∏ TwitchAccount –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:

```
IntegrityError at /panel/ProxyApp/proxy/
UNIQUE constraint failed: TwitchApp_twitchaccount.proxy_id
```

### –ü—Ä–∏—á–∏–Ω–∞

1. **OneToOneField —Å default –∑–Ω–∞—á–µ–Ω–∏–µ–º**: –í –º–æ–¥–µ–ª–∏ `TwitchAccount` –±—ã–ª–æ –ø–æ–ª–µ `proxy` —Å `default=Proxy.get_valid_twitch_free_proxy`, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏.

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–æ–∫—Å–∏**: Django –ø—ã—Ç–∞–ª—Å—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø—Ä–æ–∫—Å–∏ (–∏–ª–∏ None) –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∞–∫–∫–∞—É–Ω—Ç–∞–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**: –ò–º–ø–æ—Ä—Ç–µ—Ä—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ —Å–ª—É—á–∞–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏.

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ú–æ–¥–µ–ª—å TwitchAccount (`TwitchApp/models.py`)

**–ë—ã–ª–æ:**
```python
proxy = models.OneToOneField(Proxy, default=Proxy.get_valid_twitch_free_proxy, 
                             on_delete=models.SET_DEFAULT, ...)
```

**–°—Ç–∞–ª–æ:**
```python
proxy = models.OneToOneField(Proxy, on_delete=models.SET_NULL, 
                             related_name='twitch_account', blank=True, null=True)
```

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ú–µ—Ç–æ–¥ `save()` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∫—Å–∏
- –£–ª—É—á—à–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `update_self_proxy()` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏

### 2. –ú–æ–¥–µ–ª—å Proxy (`ProxyApp/models.py`)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `get_free_proxy_count()` - –ø–æ–¥—Å—á–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏
- `assign_proxies_to_accounts_without_proxy()` - –º–∞—Å—Å–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏

### 3. –ò–º–ø–æ—Ä—Ç–µ—Ä TwitchAccount (`TwitchApp/importer.py`)

**–£–ª—É—á—à–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏

### 4. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ö–Ω–æ–ø–∫–∞ "üîó –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º" –≤ –∞–¥–º–∏–Ω–∫–µ Proxy –∏ TwitchAccount
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–∫—Å–∏
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–∞–ª–∏—á–∏—é –ø—Ä–æ–∫—Å–∏

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –û—à–∏–±–∫–∞ `IntegrityError` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –±–µ–∑ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø—Ä–æ–∫—Å–∏
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–∞—Ç—É—Å–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ê–∫–∫–∞—É–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ (—Å proxy=None –µ—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö)
- ‚úÖ –ò–º–ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∫–Ω–æ–ø–∫–æ–π –º–∞—Å—Å–æ–≤–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ú–∞—Å—Å–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏

1. **–ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É**: –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üîó –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º"
2. **–ß–µ—Ä–µ–∑ –∫–æ–¥**:
```python
from ProxyApp.models import Proxy
assigned_count = Proxy.assign_proxies_to_accounts_without_proxy()
print(f"–ù–∞–∑–Ω–∞—á–µ–Ω–æ {assigned_count} –ø—Ä–æ–∫—Å–∏")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```python
from ProxyApp.models import Proxy
from TwitchApp.models import TwitchAccount

print(f"–°–≤–æ–±–æ–¥–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏: {Proxy.get_free_proxy_count()}")
print(f"–ê–∫–∫–∞—É–Ω—Ç–æ–≤ –±–µ–∑ –ø—Ä–æ–∫—Å–∏: {TwitchAccount.objects.filter(proxy=None).count()}")
```

## –ú–∏–≥—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `0002_fix_proxy_constraint.py` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏ –ø—Ä–æ–∫—Å–∏-–∞–∫–∫–∞—É–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- –ù–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ –±–µ–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏
- –ü—Ä–æ–∫—Å–∏ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –±–µ–∑ –ø—Ä–æ–∫—Å–∏
- ‚úÖ –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ–∫—Å–∏ (280+)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø—Ä–æ–∫—Å–∏ 